<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">

		<title>MapBox</title>
		<script
	  src="https://code.jquery.com/jquery-3.2.1.min.js"
	  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
	  crossorigin="anonymous">
	  </script>
	  <script src='//api.tiles.mapbox.com/mapbox.js/plugins/turf/v2.0.0/turf.min.js' charset='utf-8'></script>
	  <script src='https://api.mapbox.com/mapbox-gl-js/v0.36.0/mapbox-gl.js'></script>
		<link href='https://api.mapbox.com/mapbox-gl-js/v0.36.0/mapbox-gl.css' rel='stylesheet' />
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha.6/css/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" href="css/styles.min.css">
	</head>

		<body ng-app="resourcesApp" class="" ng-controller="mainController">

			<div id="wrapper">
				
				<div class="map" id="map">
					<nav>
						<ul>
							<!-- <li class="berlin" onclick="moveToLocation(this)" id="13.400841090074266, 52.516494872956116">Berlin</li>
							<li class="newYork" onclick="moveToLocation(this)" id="-73.98562338336815, 40.73037341203556">New York</li>
							<li class="london" onclick="moveToLocation(this)" id="-0.088670, 51.513259">London</li> -->
						</ul>
						<button id="animateControl" class="button" value="Stop"></button>
					</nav>
				</div>
				<p id="info"></p>
			</div>
			<script>
				mapboxgl.accessToken = 'pk.eyJ1IjoibXJhd2Vzb21lIiwiYSI6ImNqMzJzeDN4ZjAwMHAyd250YmRyZm04MDcifQ.YcsqDP3hqulR3f523AoB1g';

				var start = [-0.217833, 51.511892],
				end = [-0.088670, 51.513259],
				markersArray = [], timeoutsArray = [], locationsArray = [],
				isAtStart = true, animateStop = false,

				tateModern = {center: [-0.09888205410763362, 51.507763394932056], duration:5000, zoom:15, bearing: -150, text: "The Tate, there's some beautiful art here", id: 'cp_cathedral'},
				buckinghamPalace = {center: [-0.14244305655236644, 51.5008146674389], duration:8000, bearing:65, pitch:100, zoom:15.5, text: "The Queen's little detached cottage", id: 'cp_columbus'},
				portobelloRoad = {center: [-0.20194451426925752, 51.51267724975435], pitch: 25, bearing: -57, duration:6000, zoom:17, text: "Portobello Road, rumor has it there is a cool market here", id:'trump_tower', boundries: [[-73.97386832165292, 40.762795049517166], [-73.97316570353738, 40.76248143866823], [-73.97353077998658, 40.76199663367237], [-73.97423647668262, 40.762303489374546], [-73.97386832165292, 40.762795049517166]]},
				embassyCafe = {center: [-0.21644505735605435, 51.51031824668391], bearing:15, duration:6000, pitch:45,  zoom:16, text: "Embassy cafe! Not sure why, but Giulio requested it, and he's my boss", id:'empire'},
				pigAndWhistle = {center: [-0.21759153731389347, 51.514102963196734], bearing:-17.6, duration:8000, pitch:45, zoom:17, text: 'Pig and Whistle. The "Jerk Chicken" leaves much to be desired!!', id:'liberty'},
				theOffice = {center: [-0.2177598856553402, 51.512208058259205], pitch: 80, bearing: 130, duration:8000, zoom:16, text: 'Interstate HQ! This is where the magic happens baby', id:'race_track'},
				buildingCover = [[-73.98298924526172, 40.757523684874144], [-73.98257129198404, 40.75730063091109], [-73.98279427026381, 40.75706271234105], [-73.9830146849198, 40.756979858365554], [-73.9831166057514, 40.75739603524059]];

				locationsArray.push(tateModern, buckinghamPalace, portobelloRoad, embassyCafe, pigAndWhistle, theOffice);

				var bounds = [
				    [-0.5152859255479996, 51.28841529422982], // Southwest coordinates
				    [1.2400252619251546, 52.145907171139896]  // Northeast coordinates
				];

				var line = [
					[-0.08676914764919275, 51.51094850887958],
					[-0.08885636446717626, 51.51344514237232],
					[-0.08728356854300046, 51.51390968041969],
					[-0.08779728050365065, 51.51462274189379],
					[-0.0868314945714701, 51.51478507301533]
				];

				var map = new mapboxgl.Map({
					container: 'map',
					center: start,
					zoom: 11,
					maxBounds: bounds,
					pitch: 60,
    			bearing: 15, 
					style: 'mapbox://styles/mrawesome/cj3zqegz42h4b2sry0ifcc4a5'
				}).addControl(new mapboxgl.NavigationControl());

				// map.on('mousemove', function (e) {
			 //    document.getElementById('info').innerHTML =
			 //    JSON.stringify(e.lngLat);
				// });

				function createLabel(locationObj) {
						   
			    var el = document.createElement('h4');
			    el.className = 'label';
			    el.id = locationObj.id;
			    el.innerHTML = locationObj.text;

			   	var marker = new mapboxgl.Marker(el);
			   	markersArray.push(marker);
			    marker.setLngLat(locationObj.center).addTo(map);
				}

				function goTo(locationObj) {

					map.easeTo(locationObj);
					createLabel(locationObj);
				}

				map.on('load', function() {
			    map.addLayer({
			        'id': '3d-buildings',
			        'source': 'composite',
			        'source-layer': 'building',
			        'filter': ['==', 'extrude', 'true'],
			        'type': 'fill-extrusion',
			        'minzoom': 4,
			        'paint': {
			            'fill-extrusion-color': '#f7f3e6',
			            'fill-extrusion-height': {
			                'type': 'identity',
			                'property': 'height'
			            },
			            'fill-extrusion-base': {
			                'type': 'identity',
			                'property': 'min_height'
			            },
			            'fill-extrusion-opacity': 0.75
			        }
			    });

			    map.addLayer({
		        'id': 'trumpBuilding',
		        'source': 'composite',
			      'source-layer': 'building',
			      'filter': ["all",['==', 'height', 202]],
		        'type': 'fill-extrusion',
		        'paint': {
		        	'fill-extrusion-color': '#FFD700',
	            'fill-extrusion-height':  {
                'type': 'identity',
                'property': 'height'
		          },
		          'fill-extrusion-opacity': 1
		        }
		    	});

		    	map.addLayer({
		        'id': 'buildingCover',
		        'type': 'fill-extrusion',
		        'source': {
		            'type': 'geojson',
		            'data': {
		                'type': 'Feature',
		                'geometry': {
		                    'type': 'Polygon',
		                    'coordinates': [buildingCover]
		                }
		            }
		        },
		        'paint': {
		        	'fill-extrusion-color': '#002a3d',
	            'fill-extrusion-height': 202,
		          'fill-extrusion-opacity': 1,
		          'fill-extrusion-base': 0
		        }
		    	});

					// map.addLayer({
		   //      'id': 'empireStateB',
		   //      'source': 'composite',
			  //     'source-layer': 'building',
			  //     'filter': ["all",['==', 'height', 390]],
		   //      'type': 'fill-extrusion',
		   //      'paint': {
		   //      	'fill-extrusion-color': '#BF0A30',
	    //         'fill-extrusion-height': 440,
		   //        'fill-extrusion-opacity': 0.4
		   //      }
		   //  	});
			    function rotator() {

			    	if(animateStop === true) {

			    		return null;
			    	}

			    	var totalTimeout = 1000;

			    	var timeout1 = window.setTimeout(function() {

						  goTo(tateModern);
						}, totalTimeout);

			    	totalTimeout += tateModern.duration + 1000;

						var timeout2 = window.setTimeout(function() {

						  	pinSetup(tateModern);
						   	goTo(buckinghamPalace);
						}, totalTimeout);

						totalTimeout += buckinghamPalace.duration + 500;

						var timeout3 = window.setTimeout(function() {

				    	pinSetup(buckinghamPalace);
				      goTo(portobelloRoad);
				    }, totalTimeout);

				    totalTimeout += portobelloRoad.duration + 1000;

					  var timeout4 = window.setTimeout(function() {

			      	pinSetup(portobelloRoad);
				      goTo(embassyCafe);
						}, totalTimeout);

						totalTimeout += embassyCafe.duration + 1000;

						var timeout5 = window.setTimeout(function() {
			
			      	pinSetup(embassyCafe);
				      goTo(pigAndWhistle);
						}, totalTimeout);

						totalTimeout += pigAndWhistle.duration + 500;

						var timeout6 = window.setTimeout(function() {

			      	pinSetup(pigAndWhistle);
				      goTo(theOffice);
				    }, totalTimeout);

						totalTimeout += theOffice.duration + 2000;

  					var timeout7 = window.setTimeout(function() {

							pinSetup(theOffice);
	  					map.flyTo({center: start, zoom: 12.5, duration: 3000, pitch: 60, bearing: 15}); // ZOOM OUT AND CENTER MAP AFTER ANIMATION. \\
	  				}, totalTimeout);

	  				totalTimeout += 10000;
	  					
  					rotatorReset(totalTimeout, rotator); // RESTART ANIMATION AFTER 10 SECONDS. \\

	  				timeoutsArray.push(timeout7, timeout6, timeout5, timeout4, timeout3, timeout2, timeout1);
					}

					var rotatorResetTimeout, timeout8;
					function rotatorReset(timeOut, callBack) {

						rotatorResetTimeout = window.setTimeout(function() {

							markersArray.forEach(function(marker) {
								marker.remove();
							});

							if(callBack) {

								callBack();
							}
	  				}, timeOut);
					}

					rotator();

					function pinSetup(locationObj) {

						$('#'+locationObj.id).html('')

							.css({'background-image':'url("NIO_MAP_PIN_2.svg")', 'height': '27px', 'width': '20px', 'background-size': '100%'})

							.click(function() {

								timeoutsArray.forEach(function(timOut) {
									
	  							window.clearTimeout(timOut);
	  						});

								window.clearTimeout(rotatorResetTimeout);
	  						this.remove();

	  						if(animateStop === false) {

	  							goTo(locationObj);
	  							timeout8 = window.setTimeout(function() {

				  					pinSetup(locationObj);
				  					map.flyTo({center: start, zoom: 12.5, duration: 3000, pitch: 60, bearing: 15});

				  					rotatorReset(10000, rotator);

				  				}, locationObj.duration + 3000);
	  						}
	  						timeoutsArray.push(timeout8);
	  					});
					}

					$('#animateControl').click(function() {
						
						if(this.value === 'Play') {

							animateStop = false;
							this.value = 'Stop';
							this.style.backgroundColor = '#e55e5e';
							$(this).removeClass('stopped');

							rotatorReset(0, function() {

								timeoutsArray.forEach(function(timOut) {
									
	  							window.clearTimeout(timOut);
	  						});

	  						window.clearTimeout(rotatorResetTimeout);
								rotator();
							});
						}
						else {

							animateStop = true;
							map.stop();
							timeoutsArray.forEach(function(timOut) {
									
	  							window.clearTimeout(timOut);
	  					});
	  					window.clearTimeout(rotatorResetTimeout);

							this.value = 'Play';
							this.style.backgroundColor = '#56b881';
							$(this).addClass('stopped');
						}
					});

			   //  var geojson = {
				  //   "type": "FeatureCollection",
				  //   "features": [
				  //       {
				  //           "type": "Feature",
				  //           "properties": {
				  //               "message": "Starting point.",
				  //               "iconSize": [40, 40],
				  //               "url": 'url("http://icons.iconarchive.com/icons/icons-land/vista-map-markers/128/Map-Marker-Marker-Outside-Chartreuse-icon.png")'
				  //           },
				  //           "geometry": {
				  //               "type": "Point",
				  //               "coordinates": line[0]
				  //           }
				  //       },
				  //       {
				  //           "type": "Feature",
				  //           "properties": {
				  //               "message": "End Point.",
				  //               "iconSize": [50, 50],
				  //               "url": 'url("http://icons.iconarchive.com/icons/paomedia/small-n-flat/1024/map-marker-icon.png")'
				  //           },
				  //           "geometry": {
				  //               "type": "Point",
				  //               "coordinates": line[4]
				  //           }
				  //       }
				  //   ]
				  // };

				  // function animate() {
			   //      // Update point geometry to a new position based on counter denoting
			   //      // the index to access the arc.
			   //      point.features[0].geometry.coordinates = route.features[0].geometry.coordinates[counter];

			   //      // Update the source with this new data.
			   //      map.getSource('point').setData(point);

			   //      // Request the next frame of animation so long as destination has not
			   //      // been reached.
			   //      if(point.features[0].geometry.coordinates !== line[4]) {
			   //          requestAnimationFrame(animate);
			   //      }

			   //      counter = counter + 1;
			   //  }

			   // geojson.features.forEach(createMarkers);

		     var counter = 0;

			    // map.addSource('point', {
			    //     "type": "geojson",
			    //     "data": point
			    // });

			    // map.addLayer({
			    //     "id": "point",
			    //     "source": "point",
			    //     "type": "circle",
			    //     "paint": {
			    //         "circle-radius": 10,
			    //         "circle-color": "#007cbf"
			    //     }
			    // });
			});

				// var route = {
				//     "type": "FeatureCollection",
				//     "features": [{
				//         "type": "Feature",
				//         "geometry": {
				//             "type": "LineString",
				//             "coordinates": line
				//         }
				//     }]
				// };

				// var point = {
				//     "type": "FeatureCollection",
				//     "features": [{
				//         "type": "Feature",
				//         "geometry": {
				//             "type": "Point",
				//             "coordinates": line[0]
				//         }
				//     }]
				// };

				// var lineDistance = turf.lineDistance(route.features[0], 'kilometers');

				// setTimeout(function() {
		    // depending on whether we're currently at point a or b, aim for
		    // point a or b
		    var target = isAtStart ? end : start;

		    // and now we're at the opposite point
		    isAtStart = !isAtStart;

		   

				     function createMarkers(marker) {
						    // create a DOM element for the marker
						    var el = document.createElement('div');
						    el.className = 'marker';
						    el.style.backgroundImage = marker.properties.url;
						    el.style.width = marker.properties.iconSize[0] + 'px';
						    el.style.height = marker.properties.iconSize[1] + 'px';

						     var popup = new mapboxgl.Popup({offset: 25})
				    				.setText(marker.properties.message);

						    // add marker to map
						    new mapboxgl.Marker(el, {offset: [-marker.properties.iconSize[0] / 2, -marker.properties.iconSize[1] / 2]})
						        .setLngLat(marker.geometry.coordinates)
						        .addTo(map)
						        .setPopup(popup);
						}

					    // setTimeout(function() {
					    // 	console.log('started');
					    // 	animate(counter);
					    // }, 20000)

		    // }, 4000)

			</script>
			<script type="text/javascript" src="js/script.min.js"></script>
		</body>
	</html>
